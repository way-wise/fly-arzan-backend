// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model user {
  id            String    @id @default(ulid())
  name          String
  email         String    @unique
  emailVerified Boolean
  image         String?   @db.Text
  role          String?   @default("user")
  banned        Boolean?
  banReason     String?   @db.Text
  banExpires    Int?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  session       session[]
  account       account[]

  // Customer communication preferences
  wantsNotifications                Boolean   @default(true)
  wantsNewsletter                   Boolean   @default(false)
  communicationPreferencesUpdatedAt DateTime?

  // Relations
  notifications notification[]

  @@index([name])
  @@index([email])
  @@index([emailVerified])
  @@index([role])
  @@index([banned])
}

// In-app notifications for users
model notification {
  id        String   @id @default(ulid())
  userId    String
  user      user     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  message   String   @db.Text
  type      String   @default("info") // info, warning, promo, system
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

// Email campaigns sent by admin
model emailCampaign {
  id             String                   @id @default(ulid())
  subject        String
  content        String                   @db.Text
  sentById       String // admin user id who sent it
  recipientCount Int
  status         String                   @default("sent") // draft, sent, failed
  createdAt      DateTime                 @default(now())
  recipients     emailCampaignRecipient[]

  @@index([status])
  @@index([createdAt])
}

// Track which users received which email campaign
model emailCampaignRecipient {
  id         String        @id @default(ulid())
  campaignId String
  campaign   emailCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  userId     String
  email      String
  status     String        @default("sent") // sent, delivered, opened, bounced
  sentAt     DateTime      @default(now())

  @@index([campaignId])
  @@index([userId])
}

// Dynamic Permission System
model role {
  id          String   @id @default(ulid())
  name        String   @unique // e.g., "admin", "moderator", "user"
  description String?
  isSystem    Boolean  @default(false) // System roles cannot be deleted
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions rolePermission[]

  @@index([name])
  @@index([isSystem])
}

model permission {
  id          String   @id @default(ulid())
  resource    String // e.g., "user", "cms", "analytics"
  action      String // e.g., "create", "read", "update", "delete"
  displayName String // e.g., "Create User"
  description String?
  group       String // For UI grouping: "user_management", "content", "analytics"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions rolePermission[]

  @@unique([resource, action])
  @@index([resource])
  @@index([group])
}

model rolePermission {
  id           String   @id @default(ulid())
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  role       role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model session {
  id             String   @id @default(ulid())
  expiresAt      DateTime
  token          String   @unique
  impersonatedBy String?
  ipAddress      String?
  userAgent      String?  @db.Text
  userId         String
  user           user     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([userId, token])
}

model account {
  id                    String    @id @default(ulid())
  accountId             String
  providerId            String
  userId                String
  user                  user      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?   @db.Text
  refreshToken          String?   @db.Text
  idToken               String?   @db.Text
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
}

// Required by better-auth for OAuth state verification
model verification {
  id         String   @id @default(ulid())
  identifier String
  value      String   @db.Text
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
}

model country {
  id               Int       @id @default(autoincrement())
  iso              String    @unique
  iso3             String?
  isoNumeric       Int?
  fips             String?
  name             String
  capital          String?
  areaSqKm         Float?
  population       BigInt?
  continent        String?
  tld              String?
  currencyCode     String?
  currencyName     String?
  phoneCode        String?
  postalCodeFormat String?
  postalCodeRegex  String?
  languages        String?
  geonameid        Int?
  neighbours       String?
  regions          region[]
  airlines         airline[]
  cities           city[]
}

model region {
  id            Int     @id @default(autoincrement())
  code          String  @unique
  localCode     String?
  name          String
  continent     String?
  isoCountry    String
  country       country @relation(fields: [isoCountry], references: [iso], onDelete: Cascade)
  wikipediaLink String? @db.Text
  keywords      String? @db.Text
  cities        city[]

  @@index([isoCountry])
}

model city {
  id         Int       @id @default(autoincrement())
  name       String
  countryIso String
  country    country   @relation(fields: [countryIso], references: [iso], onDelete: Cascade)
  regionCode String
  region     region    @relation(fields: [regionCode], references: [code], onDelete: Cascade)
  airports   airport[]

  @@index([name])
  @@index([countryIso])
  @@index([regionCode])
}

model airport {
  id               Int     @id @default(autoincrement())
  ident            String? @unique
  type             String
  name             String
  latitudeDeg      Float?
  longitudeDeg     Float?
  elevationFt      Int?
  continent        String?
  cityId           Int
  city             city    @relation(fields: [cityId], references: [id], onDelete: Cascade)
  scheduledService Boolean
  icaoCode         String? @unique
  iataCode         String?
  gpsCode          String?
  localCode        String?
  homeLink         String? @db.Text
  wikipediaLink    String? @db.Text
  keywords         String? @db.Text

  @@index([iataCode])
  @@index([cityId])
}

model airline {
  id         Int     @id @default(autoincrement())
  name       String
  iata       String?
  icao       String? @unique
  website    String? @db.Text
  notes      String? @db.Text
  isUpToDate Boolean
  countryIso String
  country    country @relation(fields: [countryIso], references: [iso], onDelete: Cascade)

  @@index([countryIso])
}

/// Analytics: records of user searches
model searchEvent {
  id             String   @id @default(ulid())
  createdAt      DateTime @default(now())
  // route info
  origin         String // IATA code (e.g., ALA)
  destination    String // IATA code (e.g., IST)
  tripType       String // one-way | round-trip | multi-city
  travelClass    String? // economy | business | first
  adults         Int      @default(1)
  children       Int      @default(0)
  // device info (parsed from userAgent)
  browser        String?
  browserVersion String?
  os             String?
  osVersion      String?
  deviceType     String? // mobile | tablet | desktop
  // context
  userAgent      String?  @db.Text
  ipMasked       String?
  country        String? // ISO country code (from IP geolocation)
  region         String? // Region/state (from IP geolocation)
  // affiliate/attribution context
  sessionId      String?
  requestId      String?
  referrer       String?  @db.Text
  utmSource      String?
  utmMedium      String?
  utmCampaign    String?
  utmContent     String?
  utmTerm        String?

  @@index([createdAt])
  @@index([origin, destination])
  @@index([tripType])
  @@index([os])
  @@index([browser])
  @@index([deviceType])
  @@index([country])
  @@index([utmSource])
  @@index([sessionId])
}

/// CMS: editable static pages
model cmsPage {
  id        String   @id @default(ulid())
  slug      String   @unique
  title     String
  content   Json
  status    String   @default("published")
  updatedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
}

/// Analytics: records of click-outs to partners
model clickOutEvent {
  id          String   @id @default(ulid())
  createdAt   DateTime @default(now())
  // route info
  origin      String
  destination String
  tripType    String
  partner     String? // partner identifier if available
  // context
  userAgent   String?  @db.Text
  ipMasked    String?
  // affiliate/attribution context
  sessionId   String?
  requestId   String?
  referrer    String?  @db.Text
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmContent  String?
  utmTerm     String?
  // optional commercial context at click time
  price       Float?
  currency    String?
  deepLink    String?  @db.Text

  @@index([createdAt])
  @@index([origin, destination])
  @@index([tripType])
  @@index([partner])
  @@index([utmSource])
  @@index([sessionId])
}
